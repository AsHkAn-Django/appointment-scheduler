{% extends 'base.html' %} {% load django_bootstrap5 %} {% block content %}
<div class="container m-4 text-center col-6">
  <h2>Reserve an Appointment</h2>

  {% if appointment %}
  <div class="card text-start">
    <div class="card-body">
      <h4 class="card-title">Appointment Exist!</h4>
      <p class="card-text">
        You have an appointment on {{appointment.date}} at
        {{appointment.get_time}}.
      </p>
    </div>
  </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}

    <div class="mb-3">
      <label for="id_date">Date:</label>
      {{ form.date }}
    </div>

    <div class="mb-3">
      <label for="id_hour">Hour:</label>
      {{ form.hour }}
    </div>

    <div class="mb-3">
      <label for="id_minute">Minute:</label>
      {{ form.minute }}
    </div>

    <div class="mb-3">
      <label for="id_details">Details:</label>
      {{ form.details }}
    </div>

    <button type="submit" class="btn btn-primary">Book Appointment</button>
  </form>
</div>

<!-- flatpickr CSS -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<!-- flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const hourSelect = document.getElementById("id_hour");
    const dateInput = document.getElementById("id_date");
    const minuteSelect = document.getElementById("id_minute");

    dateInput.addEventListener("change", function () {
      const selectedDate = dateInput.value;

      if (!selectedDate) return;

      fetch(`/get-available-hours/?date=${selectedDate}`)
        .then((response) => response.json())
        .then((data) => {
          hourSelect.innerHTML = "";
          hourSelect.disabled = false;
          data.forEach((hour) => {
            const option = document.createElement("option");
            option.value = hour;
            option.textContent = hour.toString().padStart(2, "0");
            hourSelect.appendChild(option);
          });
        });
    });

    if (!hourSelect || !dateInput || !minuteSelect) {
      console.error(
        "One or more elements not found: #id_hour, #id_date, #id_minute"
      );
      return;
    }

    hourSelect.addEventListener("change", function () {
      const selectedHour = hourSelect.value;
      const selectedDate = dateInput.value;

      if (!selectedHour || !selectedDate) return;

      fetch(`/get-available-minutes/?hour=${selectedHour}&date=${selectedDate}`)
        .then((response) => response.json())
        .then((data) => {
          // Clear old options
          minuteSelect.innerHTML = "";
          minuteSelect.disabled = false;

          // Add new options
          data.forEach((minute) => {
            const option = document.createElement("option");
            option.value = minute;
            option.textContent = minute.toString().padStart(2, "0");
            minuteSelect.appendChild(option);
          });
        })
        .catch((error) => {
          console.error("Error fetching minutes:", error);
        });
    });
  });
  document.addEventListener("DOMContentLoaded", function () {
    flatpickr(".datepicker", {
      dateFormat: "Y-m-d",
      minDate: "today", // disables all past days
    });
  });
</script>
{% endblock content %}
