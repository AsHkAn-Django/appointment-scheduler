{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% block content %}
<div class="container m-4 text-center col-6">
  <h2>Reserve an Appointment</h2>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  {% if appointment and not form.errors %}
    <div class="card text-start mb-4">
      <div class="card-body">
        <h4 class="card-title">Appointment Exists!</h4>
        <p class="card-text">
          You have an appointment on {{ appointment.date }} at {{ appointment.get_time }}.
        </p>
      </div>
    </div>
  {% endif %}

  {% if not appointment or form.errors %}
    <form method="post">
      {% csrf_token %}

      <div class="mb-3">
        <label for="id_date">Date:</label>
        {{ form.date }}
        {% if form.date.errors %}
          <div class="text-danger">{{ form.date.errors }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        <label for="id_hour">Hour:</label>
        {{ form.hour }}
        {% if form.hour.errors %}
          <div class="text-danger">{{ form.hour.errors }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        <label>Minute:</label>
        <div id="minute-options" style="margin-top: 5px;"></div>
        {% if form.minute.errors %}
          <div class="text-danger">{{ form.minute.errors }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        <label for="id_details">Details:</label>
        {{ form.details }}
        {% if form.details.errors %}
          <div class="text-danger">{{ form.details.errors }}</div>
        {% endif %}
      </div>

      <button type="submit" class="btn btn-primary">Book Appointment</button>
    </form>
  {% endif %}
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const hourSelect = document.getElementById("id_hour");
    const dateInput = document.getElementById("id_date");
    const minuteContainer = document.getElementById("minute-options");

    hourSelect.disabled = true;
    minuteContainer.innerHTML = "";
    minuteContainer.style.pointerEvents = "none";

    dateInput.addEventListener("change", function () {
      const selectedDate = dateInput.value;
      if (!selectedDate) return;

      fetch(`/get-available-hours/?date=${selectedDate}`)
        .then(res => res.json())
        .then(hours => {
          hourSelect.innerHTML = "";
          if (!hours.length) {
            hourSelect.disabled = true;
            minuteContainer.innerHTML = "";
            minuteContainer.style.pointerEvents = "none";
            return;
          }

          hourSelect.disabled = false;
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "Select hour";
          hourSelect.appendChild(placeholder);

          hours.forEach(hour => {
            const opt = document.createElement("option");
            opt.value = hour;
            opt.textContent = hour.toString().padStart(2, '0');
            hourSelect.appendChild(opt);
          });

          minuteContainer.innerHTML = "";
          minuteContainer.style.pointerEvents = "none";
        });
    });

    hourSelect.addEventListener("change", function () {
      const selectedHour = hourSelect.value;
      const selectedDate = dateInput.value;
      minuteContainer.innerHTML = "";
      minuteContainer.style.pointerEvents = "none";

      if (!selectedHour || !selectedDate) return;

      fetch(`/get-available-minutes/?hour=${selectedHour}&date=${selectedDate}`)
        .then(res => res.json())
        .then(minutes => {
          if (!minutes.length) {
            minuteContainer.innerHTML = "<p>No available times for this hour.</p>";
            return;
          }

          minuteContainer.style.pointerEvents = "auto";

          minutes.forEach((m, i) => {
            const rid = `minute_radio_${i}`;
            const radio = document.createElement("input");
            radio.type = "radio";
            radio.id = rid;
            radio.name = "minute";
            radio.value = m;

            const label = document.createElement("label");
            label.htmlFor = rid;
            label.textContent = `${selectedHour.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            label.style.marginRight = "10px";

            minuteContainer.appendChild(radio);
            minuteContainer.appendChild(label);
          });
        })
        .catch(err => {
          console.error('Error loading minutes:', err);
          minuteContainer.innerHTML = "<p>Error loading minutes.</p>";
        });
    });

    flatpickr(dateInput, { dateFormat: 'Y-m-d', minDate: 'today' });
  });
</script>
{% endblock content %}
